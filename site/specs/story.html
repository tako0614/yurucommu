<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Extension - ActivityPub拡張仕様 - Yurucommu</title>
  <meta name="description" content="ActivityPub Story拡張仕様。24時間で消える一時的なコンテンツの配信について定義">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">Yurucommu</a>
      <div class="header-links">
        <a href="/docs/" class="header-link">Docs</a>
        <a href="/specs/" class="header-link active">Specs</a>
      </div>
      <a href="https://github.com/example/yurucommu" class="header-cta">
        GitHub
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
        </svg>
      </a>
    </div>
  </header>

  <div class="docs-layout">
    <!-- Sidebar -->
    <aside class="docs-sidebar">
      <p class="docs-sidebar-title">仕様</p>
      <ul class="docs-sidebar-nav">
        <li><a href="/specs/">概要</a></li>
        <li><a href="/specs/activitypub.html">ActivityPub拡張</a></li>
        <li><a href="/specs/yurucommu.html">Yurucommu仕様</a></li>
        <li><a href="/specs/namespace.html">名前空間</a></li>
      </ul>

      <div class="docs-sidebar-section">
        <p class="docs-sidebar-title">ActivityPub拡張</p>
        <ul class="docs-sidebar-nav">
          <li><a href="/specs/apc.html">APC (Communities)</a></li>
          <li><a href="/specs/single-user.html">Single-User Instance</a></li>
          <li><a href="/specs/story.html" class="active">Story</a></li>
          <li><a href="/specs/dmnote.html">DM Note</a></li>
        </ul>
      </div>

      <div class="docs-sidebar-section">
        <p class="docs-sidebar-title">Yurucommu仕様</p>
        <ul class="docs-sidebar-nav">
          <li><a href="/specs/qr-exchange.html">QR Exchange</a></li>
        </ul>
      </div>

      <div class="docs-sidebar-section">
        <p class="docs-sidebar-title">リソース</p>
        <ul class="docs-sidebar-nav">
          <li><a href="https://www.w3.org/TR/activitypub/">ActivityPub (W3C)</a></li>
          <li><a href="https://www.w3.org/TR/activitystreams-core/">Activity Streams 2.0</a></li>
        </ul>
      </div>
    </aside>

    <!-- Content -->
    <main class="docs-content">
      <span class="spec-status draft">Draft v2</span>
      <h1>Story Extension</h1>
      <p class="lead">
        24時間で消える一時的なコンテンツ（ストーリー）をActivityPubで配信するための拡張仕様。
        Instagram StoriesやSnapchat Storiesのような機能を分散SNSで実現します。
      </p>

      <h2>概要</h2>
      <p>
        Story拡張は、時間制限付きのコンテンツを配信するためのActivityPub拡張です。
        AS2標準の <code>Note</code> を拡張し、単一のメディア（画像または動画）と
        インタラクティブなオーバーレイ（投票など）を定義します。
      </p>

      <h3>設計方針</h3>
      <ul>
        <li><strong>1投稿 = 1メディア</strong> - 各Storyは独立した画像または動画を持つ</li>
        <li><strong>テキスト/スタンプは焼き込み</strong> - メディアに合成済みの状態で配信</li>
        <li><strong>インタラクティブ要素は分離</strong> - 投票などは <code>overlays</code> で定義</li>
        <li><strong>連続再生はUIの責務</strong> - 同一ユーザーの複数Storyをクライアントが連続表示</li>
        <li><strong>AS2互換</strong> - Story非対応の実装でも通常のNoteとして表示可能</li>
      </ul>

      <h2>名前空間</h2>
      <p>Story拡張は以下の名前空間を使用します：</p>
      <pre><code>https://yurucommu.com/ns/story#</code></pre>

      <h3>JSON-LD Context</h3>
      <pre><code>{
  "@context": [
    "https://www.w3.org/ns/activitystreams",
    {
      "story": "https://yurucommu.com/ns/story#",
      "xsd": "http://www.w3.org/2001/XMLSchema#",

      "Story": "story:Story",

      "displayDuration": {
        "@id": "story:displayDuration",
        "@type": "xsd:duration"
      },

      "overlays": {
        "@id": "story:overlays",
        "@container": "@list"
      },

      "position": "story:position"
    }
  ]
}</code></pre>

      <h2>型定義</h2>

      <h3>Story</h3>
      <p>
        ストーリーオブジェクト。AS2の <code>Note</code> を拡張します。
        1つのStoryは1つのメディア（画像または動画）を持ちます。
      </p>

      <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
        <thead>
          <tr style="border-bottom: 1px solid var(--border);">
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">プロパティ</th>
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">型</th>
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">必須</th>
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">説明</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>type</code></td>
            <td style="padding: 0.75rem;">Array</td>
            <td style="padding: 0.75rem;">Yes</td>
            <td style="padding: 0.75rem;"><code>["Story", "Note"]</code></td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>attachment</code></td>
            <td style="padding: 0.75rem;">Document | Video</td>
            <td style="padding: 0.75rem;">Yes</td>
            <td style="padding: 0.75rem;">メディア（画像または動画）</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>displayDuration</code></td>
            <td style="padding: 0.75rem;">xsd:duration</td>
            <td style="padding: 0.75rem;">Yes</td>
            <td style="padding: 0.75rem;">表示時間（例: <code>PT5S</code> = 5秒）</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>endTime</code></td>
            <td style="padding: 0.75rem;">DateTime</td>
            <td style="padding: 0.75rem;">Yes</td>
            <td style="padding: 0.75rem;">ストーリーの有効期限（AS2標準）</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>overlays</code></td>
            <td style="padding: 0.75rem;">Array&lt;Object&gt;</td>
            <td style="padding: 0.75rem;">No</td>
            <td style="padding: 0.75rem;">インタラクティブなオーバーレイ要素</td>
          </tr>
        </tbody>
      </table>

      <h3>OverlayPosition</h3>
      <p>
        オーバーレイ要素の位置を指定します。座標は相対値（0.0〜1.0）で指定します。
      </p>

      <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
        <thead>
          <tr style="border-bottom: 1px solid var(--border);">
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">プロパティ</th>
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">型</th>
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">説明</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>x</code></td>
            <td style="padding: 0.75rem;">Number (0.0-1.0)</td>
            <td style="padding: 0.75rem;">要素中心のX座標（左端=0, 右端=1）</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>y</code></td>
            <td style="padding: 0.75rem;">Number (0.0-1.0)</td>
            <td style="padding: 0.75rem;">要素中心のY座標（上端=0, 下端=1）</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>width</code></td>
            <td style="padding: 0.75rem;">Number (0.0-1.0)</td>
            <td style="padding: 0.75rem;">要素の幅（キャンバス幅に対する比率）</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;"><code>height</code></td>
            <td style="padding: 0.75rem;">Number (0.0-1.0)</td>
            <td style="padding: 0.75rem;">要素の高さ（キャンバス高さに対する比率）</td>
          </tr>
        </tbody>
      </table>

      <h4>座標系</h4>
      <pre><code>┌─────────────────────────────┐
│ (0,0)                       │
│                             │
│        ┌───────┐            │
│        │ x=0.5 │ ← 中央配置  │
│        │ y=0.75│            │
│        └───────┘            │
│                       (1,1) │
└─────────────────────────────┘

x, y: 要素の中心点の位置
width, height: 要素のサイズ（相対値）</code></pre>

      <h3>Overlays</h3>
      <p>
        <code>overlays</code> 配列には任意のActivityStreams 2.0オブジェクトを含めることができます。
        各オーバーレイは <code>position</code> プロパティを持つ必要があります。
      </p>

      <p><strong>想定されるオーバーレイ型:</strong></p>
      <ul>
        <li><code>Question</code> - 投票（AS2標準）</li>
        <li><code>Note</code> - テキストリンク</li>
        <li><code>Link</code> - 外部リンク</li>
        <li>任意の拡張型</li>
      </ul>

      <h2>例</h2>

      <h3>基本的なストーリー（画像のみ）</h3>
      <pre><code>{
  "@context": [
    "https://www.w3.org/ns/activitystreams",
    {
      "story": "https://yurucommu.com/ns/story#",
      "Story": "story:Story",
      "displayDuration": "story:displayDuration"
    }
  ],
  "id": "https://example.com/users/alice/stories/2026-01-15/1",
  "type": ["Story", "Note"],
  "attributedTo": "https://example.com/users/alice",
  "published": "2026-01-15T10:00:00Z",
  "endTime": "2026-01-16T10:00:00Z",
  "to": ["https://example.com/users/alice/followers"],
  "attachment": {
    "type": "Document",
    "mediaType": "image/jpeg",
    "url": "https://example.com/media/story/abc123.jpg",
    "width": 1080,
    "height": 1920
  },
  "displayDuration": "PT5S"
}</code></pre>

      <h3>動画ストーリー</h3>
      <pre><code>{
  "@context": [
    "https://www.w3.org/ns/activitystreams",
    {
      "story": "https://yurucommu.com/ns/story#",
      "Story": "story:Story",
      "displayDuration": "story:displayDuration"
    }
  ],
  "id": "https://example.com/users/alice/stories/2026-01-15/2",
  "type": ["Story", "Note"],
  "attributedTo": "https://example.com/users/alice",
  "published": "2026-01-15T12:00:00Z",
  "endTime": "2026-01-16T12:00:00Z",
  "to": ["https://example.com/users/alice/followers"],
  "attachment": {
    "type": "Video",
    "mediaType": "video/mp4",
    "url": "https://example.com/media/story/video456.mp4",
    "width": 1080,
    "height": 1920,
    "duration": "PT15S"
  },
  "displayDuration": "PT15S"
}</code></pre>

      <h3>投票付きストーリー</h3>
      <pre><code>{
  "@context": [
    "https://www.w3.org/ns/activitystreams",
    {
      "story": "https://yurucommu.com/ns/story#",
      "Story": "story:Story",
      "displayDuration": "story:displayDuration",
      "overlays": { "@id": "story:overlays", "@container": "@list" },
      "position": "story:position"
    }
  ],
  "id": "https://example.com/users/alice/stories/2026-01-15/3",
  "type": ["Story", "Note"],
  "attributedTo": "https://example.com/users/alice",
  "published": "2026-01-15T14:00:00Z",
  "endTime": "2026-01-16T14:00:00Z",
  "to": ["https://example.com/users/alice/followers"],
  "attachment": {
    "type": "Document",
    "mediaType": "image/jpeg",
    "url": "https://example.com/media/story/poll-bg.jpg",
    "width": 1080,
    "height": 1920
  },
  "displayDuration": "PT7S",
  "overlays": [
    {
      "type": "Question",
      "name": "今日どっちがいい？",
      "oneOf": [
        { "type": "Note", "name": "A" },
        { "type": "Note", "name": "B" }
      ],
      "closed": "2026-01-15T20:00:00Z",
      "position": {
        "x": 0.5,
        "y": 0.75,
        "width": 0.8,
        "height": 0.15
      }
    }
  ]
}</code></pre>

      <h2>配信</h2>
      <p>
        StoryはActivityPubの <code>Create</code> アクティビティで配信されます。
      </p>
      <pre><code>{
  "@context": "https://www.w3.org/ns/activitystreams",
  "type": "Create",
  "actor": "https://example.com/users/alice",
  "to": ["https://example.com/users/alice/followers"],
  "object": {
    "type": ["Story", "Note"],
    "id": "https://example.com/users/alice/stories/2026-01-15/1",
    ...
  }
}</code></pre>

      <h2>連続再生</h2>
      <p>
        同一ユーザーの複数Storyは、クライアントUIが連続再生として表示します。
        これはサーバー側ではなくクライアント側の責務です。
      </p>

      <pre><code>// クライアントの表示ロジック
const storiesByUser = groupBy(stories, s => s.attributedTo);

// 各ユーザーのストーリーを published 順にソート
for (const [userId, userStories] of storiesByUser) {
  userStories.sort((a, b) =>
    new Date(a.published) - new Date(b.published)
  );
}</code></pre>

      <h2>削除</h2>
      <p>
        ストーリーの期限切れ時、または手動削除時は <code>Delete</code> アクティビティを送信します。
        <code>endTime</code> を過ぎたストーリーは、受信側で自動的に非表示にすることが推奨されます。
      </p>

      <h2>実装上の注意</h2>
      <ul>
        <li><strong>下位互換性</strong> - <code>type: ["Story", "Note"]</code> とすることで、Story非対応の実装でもNoteとして表示可能</li>
        <li><strong>期限管理</strong> - <code>endTime</code> を必ず設定し、期限切れコンテンツは表示しない</li>
        <li><strong>displayDuration形式</strong> - ISO 8601 duration形式（<code>PT5S</code> = 5秒、<code>PT1M30S</code> = 1分30秒）</li>
        <li><strong>動画の尺</strong> - 動画の実際の長さはAS2標準の <code>duration</code> プロパティを使用</li>
        <li><strong>アスペクト比</strong> - 推奨は縦型9:16（1080x1920px）。モバイルファーストで全画面表示に最適化</li>
        <li><strong>テキスト/スタンプ</strong> - メディアに焼き込み済みの状態で配信。別レイヤーとしては配信しない</li>
      </ul>

      <h3>推奨メディアサイズ</h3>
      <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
        <thead>
          <tr style="border-bottom: 1px solid var(--border);">
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">形式</th>
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">推奨サイズ</th>
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">最大尺</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;">画像</td>
            <td style="padding: 0.75rem;">1080x1920px (9:16)</td>
            <td style="padding: 0.75rem;">-</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;">動画</td>
            <td style="padding: 0.75rem;">1080x1920px (9:16)</td>
            <td style="padding: 0.75rem;">60秒</td>
          </tr>
        </tbody>
      </table>

      <h2>変更履歴</h2>
      <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
        <thead>
          <tr style="border-bottom: 1px solid var(--border);">
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">バージョン</th>
            <th style="text-align: left; padding: 0.75rem; color: var(--text-secondary);">変更内容</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;">v2 (2026-01)</td>
            <td style="padding: 0.75rem;"><code>frames</code> 配列を廃止、<code>attachment</code> をStory直下に移動、<code>overlays</code> を追加</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem;">v1 (2025-12)</td>
            <td style="padding: 0.75rem;">初期仕様（<code>frames</code> 配列ベース）</td>
          </tr>
        </tbody>
      </table>

      <h2>参考</h2>
      <ul>
        <li><a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-endtime">Activity Streams 2.0 - endTime</a></li>
        <li><a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-duration">Activity Streams 2.0 - duration</a></li>
        <li><a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-question">Activity Streams 2.0 - Question</a></li>
      </ul>
    </main>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-inner">
      <div class="footer-logo">Yurucommu</div>
      <div class="footer-links">
        <a href="/" class="footer-link">ホーム</a>
        <a href="/docs/" class="footer-link">Docs</a>
        <a href="/specs/" class="footer-link">Specs</a>
        <a href="https://github.com/example/yurucommu" class="footer-link">GitHub</a>
      </div>
      <p class="footer-copy">&copy; 2025 Yurucommu. MIT License.</p>
    </div>
  </footer>
</body>
</html>
